From 52e3455eaa515a9f4ce4077ff169c6c2c40e9904 Mon Sep 17 00:00:00 2001
From: Charlie Li <git@vishwin.info>
Date: Mon, 19 Apr 2021 17:25:22 -0400
Subject: [PATCH 1/5] LibreSSL 3.3.2 supports SSL_OP_NO_DTLS*

While here, bump CI
---
 src/_cffi_src/openssl/cryptography.py | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/src/_cffi_src/openssl/cryptography.py b/src/_cffi_src/openssl/cryptography.py
index e2b5a13..ab29634 100644
--- a/src/_cffi_src/openssl/cryptography.py
+++ b/src/_cffi_src/openssl/cryptography.py
@@ -32,6 +32,13 @@ INCLUDES = """
 #include <Winsock2.h>
 #endif
 
+#if CRYPTOGRAPHY_IS_LIBRESSL
+    #define CRYPTOGRAPHY_LIBRESSL_332_OR_GREATER \
+        (LIBRESSL_VERSION_NUMBER >= 0x3030200f)
+#else
+#define CRYPTOGRAPHY_LIBRESSL_332_OR_GREATER (0)
+#endif
+
 #define CRYPTOGRAPHY_OPENSSL_110F_OR_GREATER \
     (OPENSSL_VERSION_NUMBER >= 0x1010006f && !CRYPTOGRAPHY_IS_LIBRESSL)
 
@@ -59,6 +66,8 @@ static const int CRYPTOGRAPHY_OPENSSL_LESS_THAN_111B;
 static const int CRYPTOGRAPHY_NEEDS_OSRANDOM_ENGINE;
 
 static const int CRYPTOGRAPHY_IS_LIBRESSL;
+
+static const int CRYPTOGRAPHY_LIBRESSL_332_OR_GREATER;
 """
 
 FUNCTIONS = """
-- 
2.32.0

From ca19df93826de2eb115756fe4989cc324fa69b6e Mon Sep 17 00:00:00 2001
From: Charlie Li <git@vishwin.info>
Date: Mon, 19 Apr 2021 18:16:14 -0400
Subject: [PATCH 2/5] Switch to LESS_THAN context for LibreSSL 3.3.2

While here, fix indents
---
 src/_cffi_src/openssl/cryptography.py | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/src/_cffi_src/openssl/cryptography.py b/src/_cffi_src/openssl/cryptography.py
index ab29634..0b468c8 100644
--- a/src/_cffi_src/openssl/cryptography.py
+++ b/src/_cffi_src/openssl/cryptography.py
@@ -33,10 +33,10 @@ INCLUDES = """
 #endif
 
 #if CRYPTOGRAPHY_IS_LIBRESSL
-    #define CRYPTOGRAPHY_LIBRESSL_332_OR_GREATER \
-        (LIBRESSL_VERSION_NUMBER >= 0x3030200f)
+#define CRYPTOGRAPHY_LIBRESSL_LESS_THAN_332 \
+    (LIBRESSL_VERSION_NUMBER < 0x3030200f)
 #else
-#define CRYPTOGRAPHY_LIBRESSL_332_OR_GREATER (0)
+#define CRYPTOGRAPHY_LIBRESSL_LESS_THAN_332 (0)
 #endif
 
 #define CRYPTOGRAPHY_OPENSSL_110F_OR_GREATER \
@@ -67,7 +67,7 @@ static const int CRYPTOGRAPHY_NEEDS_OSRANDOM_ENGINE;
 
 static const int CRYPTOGRAPHY_IS_LIBRESSL;
 
-static const int CRYPTOGRAPHY_LIBRESSL_332_OR_GREATER;
+static const int CRYPTOGRAPHY_LIBRESSL_LESS_THAN_332;
 """
 
 FUNCTIONS = """
-- 
2.32.0

From 0fd8db239ba8a8218229a53da248261bc36b1207 Mon Sep 17 00:00:00 2001
From: Charlie Li <git@vishwin.info>
Date: Mon, 19 Apr 2021 18:22:20 -0400
Subject: [PATCH 3/5] Remove extra C variable declaration

The variable is not actually used from Python
---
 src/_cffi_src/openssl/cryptography.py | 2 --
 1 file changed, 2 deletions(-)

diff --git a/src/_cffi_src/openssl/cryptography.py b/src/_cffi_src/openssl/cryptography.py
index 0b468c8..b9c7a79 100644
--- a/src/_cffi_src/openssl/cryptography.py
+++ b/src/_cffi_src/openssl/cryptography.py
@@ -66,8 +66,6 @@ static const int CRYPTOGRAPHY_OPENSSL_LESS_THAN_111B;
 static const int CRYPTOGRAPHY_NEEDS_OSRANDOM_ENGINE;
 
 static const int CRYPTOGRAPHY_IS_LIBRESSL;
-
-static const int CRYPTOGRAPHY_LIBRESSL_LESS_THAN_332;
 """
 
 FUNCTIONS = """
-- 
2.32.0

From 71bb8c1b32cb7da6221b09dc416616031a4de5fb Mon Sep 17 00:00:00 2001
From: orbea <orbea@riseup.net>
Date: Fri, 1 Oct 2021 23:17:30 -0700
Subject: [PATCH 4/5] security/py-cryptography: fix build after
 EVP_Digest{Sign,Verify} addition

Patch from OpenBSD.

https://cvsweb.openbsd.org/cgi-bin/cvsweb/ports/security/py-cryptography/patches/patch-src__cffi_src_openssl_evp_py

Signed-off-by: orbea <orbea@riseup.net>
---
 src/_cffi_src/openssl/evp.py | 6 +-----
 1 file changed, 1 insertion(+), 5 deletions(-)

diff --git a/src/_cffi_src/openssl/evp.py b/src/_cffi_src/openssl/evp.py
index 2b2f995..dcece6f 100644
--- a/src/_cffi_src/openssl/evp.py
+++ b/src/_cffi_src/openssl/evp.py
@@ -204,14 +204,10 @@ int (*EVP_PKEY_set1_tls_encodedpoint)(EVP_PKEY *, const unsigned char *,
 #endif
 
 #if CRYPTOGRAPHY_OPENSSL_LESS_THAN_111
-static const long Cryptography_HAS_ONESHOT_EVP_DIGEST_SIGN_VERIFY = 0;
+static const long Cryptography_HAS_ONESHOT_EVP_DIGEST_SIGN_VERIFY = 1;
 static const long Cryptography_HAS_RAW_KEY = 0;
 static const long Cryptography_HAS_EVP_DIGESTFINAL_XOF = 0;
 int (*EVP_DigestFinalXOF)(EVP_MD_CTX *, unsigned char *, size_t) = NULL;
-int (*EVP_DigestSign)(EVP_MD_CTX *, unsigned char *, size_t *,
-                      const unsigned char *tbs, size_t) = NULL;
-int (*EVP_DigestVerify)(EVP_MD_CTX *, const unsigned char *, size_t,
-                        const unsigned char *, size_t) = NULL;
 EVP_PKEY *(*EVP_PKEY_new_raw_private_key)(int, ENGINE *, const unsigned char *,
                                        size_t) = NULL;
 EVP_PKEY *(*EVP_PKEY_new_raw_public_key)(int, ENGINE *, const unsigned char *,
-- 
2.32.0

From bb02823e94f79f6ff3eda254558aeacc0daa97a0 Mon Sep 17 00:00:00 2001
From: orbea <orbea@riseup.net>
Date: Fri, 1 Oct 2021 23:26:38 -0700
Subject: [PATCH 5/5] security/py-cryptography: SSL_OP_NO_DTLSv1{,_2} were
 added to libcrypto

From OpenBSD

https://cvsweb.openbsd.org/cgi-bin/cvsweb/~checkout~/ports/security/py-cryptography/patches/patch-src__cffi_src_openssl_ssl_py?rev=1.8&content-type=text/plain

Signed-off-by: orbea <orbea@riseup.net>
---
 src/_cffi_src/openssl/ssl.py | 5 ++---
 1 file changed, 2 insertions(+), 3 deletions(-)

diff --git a/src/_cffi_src/openssl/ssl.py b/src/_cffi_src/openssl/ssl.py
index 11a7d63..1d326f1 100644
--- a/src/_cffi_src/openssl/ssl.py
+++ b/src/_cffi_src/openssl/ssl.py
@@ -586,8 +586,6 @@ static const long TLS_ST_OK = 0;
 #endif
 
 #if CRYPTOGRAPHY_IS_LIBRESSL
-static const long SSL_OP_NO_DTLSv1 = 0;
-static const long SSL_OP_NO_DTLSv1_2 = 0;
 long (*DTLS_set_link_mtu)(SSL *, long) = NULL;
 long (*DTLS_get_link_min_mtu)(SSL *) = NULL;
 #endif
@@ -681,7 +679,8 @@ int (*SSL_set_tlsext_use_srtp)(SSL *, const char *) = NULL;
 SRTP_PROTECTION_PROFILE * (*SSL_get_selected_srtp_profile)(SSL *) = NULL;
 #endif
 
-#if CRYPTOGRAPHY_OPENSSL_LESS_THAN_111
+#if CRYPTOGRAPHY_OPENSSL_LESS_THAN_111 && \
+    !(CRYPTOGRAPHY_IS_LIBRESSL && defined(TLS1_3_VERSION))
 static const long Cryptography_HAS_TLSv1_3 = 0;
 static const long TLS1_3_VERSION = 0;
 static const long SSL_OP_NO_TLSv1_3 = 0;
-- 
2.32.0

